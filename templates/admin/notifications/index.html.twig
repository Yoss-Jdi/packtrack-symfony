{% extends 'admin/base.html.twig' %}

{% block title %}Notifications - PackTrack{% endblock %}

{% block body %}

    <div class="topbar">
        <h2>üîî Notifications</h2>
        <div class="user">
            <img src="https://i.pravatar.cc/40?img=3" alt="Admin">
            <span>Admin</span>
        </div>
    </div>

    {# Flash messages #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label }}" style="
                padding: 14px 18px;
                border-radius: 8px;
                margin-bottom: 20px;
                font-size: 14px;
                background: {{ label == 'success' ? '#d4edda' : '#f8d7da' }};
                color: {{ label == 'success' ? '#155724' : '#721c24' }};
                border: 1px solid {{ label == 'success' ? '#c3e6cb' : '#f5c6cb' }};
            ">
                {{ label == 'success' ? '‚úÖ' : '‚ö†Ô∏è' }} {{ message }}
            </div>
        {% endfor %}
    {% endfor %}

    {# Stats #}
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background: #e3f2fd;">üîî</div>
            <div>
                <p>Total</p>
                <h3>{{ notifications|length }}</h3>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #fff3e0;">üì¨</div>
            <div>
                <p>Non lues</p>
                <h3>{{ nbNonLues }}</h3>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #e8f5e9;">‚úÖ</div>
            <div>
                <p>Lues</p>
                <h3>{{ notifications|length - nbNonLues }}</h3>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #fff3cd;">‚ö†Ô∏è</div>
            <div>
                <p>Colis en attente</p>
                <h3>{{ colisEnAttente is defined ? colisEnAttente|length : 0 }}</h3>
            </div>
        </div>
    </div>

    {# Alerte colis en attente #}
    {% if colisEnAttente is defined and colisEnAttente|length > 0 %}
        <div style="
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-left: 5px solid #ffc107;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 14px;
        ">
            <span style="font-size: 26px;">‚ö†Ô∏è</span>
            <div>
                <strong style="color: #856404; display: block; margin-bottom: 4px;">
                    {{ colisEnAttente|length }} colis en attente depuis plus de 3 jours
                </strong>
                <span style="color: #6c5500; font-size: 13px;">
                    Ces colis n'ont pas encore √©t√© pris en charge. Pensez √† les traiter rapidement.
                </span>
            </div>
        </div>
    {% endif %}

    {# Tableau des notifications #}
    <div class="table-section">
        <div class="table-header">
            <h3>Liste des notifications</h3>
            {% if nbNonLues > 0 %}
                <form method="post" action="{{ path('app_notifications_mark_all_as_read') }}">
                    <button type="submit" style="
                        padding: 8px 18px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 13px;
                        font-weight: 600;
                        transition: background 0.2s;
                    ">
                        ‚úì Tout marquer comme lu
                    </button>
                </form>
            {% endif %}
        </div>

        {% if notifications|length > 0 %}
            <table>
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Message</th>
                        <th>Date</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for notification in notifications %}
                        <tr style="{{ not notification.lu ? 'background: #f0f7ff;' : '' }}">
                            <td>
                                {% if notification.type == 'success' %}
                                    <span class="status delivered">‚úÖ Succ√®s</span>
                                {% elseif notification.type == 'warning' %}
                                    <span class="status pending">‚ö†Ô∏è Attention</span>
                                {% elseif notification.type == 'danger' %}
                                    <span class="status" style="background:#f8d7da;color:#721c24;">‚ùå Danger</span>
                                {% else %}
                                    <span class="status transit">‚ÑπÔ∏è Info</span>
                                {% endif %}
                            </td>
                            <td style="max-width: 400px; font-size: 13px; color: #333;">
                                {{ notification.message }}
                            </td>
                            <td style="color: #999; font-size: 12px; white-space: nowrap;">
                                <i class="fa-regular fa-clock"></i>
                                {{ notification.dateCreation|date('d/m/Y √† H:i') }}
                            </td>
                            <td>
                                {% if notification.lu %}
                                    <span class="status delivered" style="font-size: 11px;">Lu</span>
                                {% else %}
                                    <span class="status pending" style="font-size: 11px;">‚óè Non lu</span>
                                {% endif %}
                            </td>
                            <td>
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    {% if not notification.lu %}
                                        <form method="post" action="{{ path('app_notification_mark_as_read', {id: notification.id}) }}">
                                            <button type="submit" class="btn-small" style="background: #667eea;" title="Marquer comme lue">
                                                <i class="fa-solid fa-check"></i>
                                            </button>
                                        </form>
                                    {% endif %}
                                    <form method="post" action="{{ path('app_notification_delete', {id: notification.id}) }}"
                                          onsubmit="return confirm('Supprimer cette notification ?')">
                                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ notification.id) }}">
                                        <button type="submit" class="btn-small" style="background: #e74c3c;" title="Supprimer">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

        {% else %}
            <p class="empty-state">üîî Aucune notification pour le moment.</p>
        {% endif %}
    </div>

    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-card p { color: #999; font-size: 12px; margin: 0; }
        .stat-card h3 { margin: 0; font-size: 28px; color: #333; }

        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .status.pending   { background: #fff3cd; color: #856404; }
        .status.transit   { background: #d1ecf1; color: #0c5460; }
        .status.delivered { background: #d4edda; color: #155724; }

        .btn-small {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 10px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: 0.2s;
            text-decoration: none;
        }

        .btn-small:hover { transform: scale(1.1); }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        thead { background: #f5f5f5; border-bottom: 2px solid #e0e0e0; }
        th { padding: 15px; text-align: left; font-weight: 600; color: #333; }
        td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; }
        tbody tr:hover { background: #f9f9f9; }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .empty-state { text-align: center; padding: 40px; color: #999; }
    </style>

{% endblock %}