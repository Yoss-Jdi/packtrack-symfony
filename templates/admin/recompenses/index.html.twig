{% extends 'admin/base.html.twig' %}

{% block title %}Liste des R√©compenses{% endblock %}

{% block body %}

<style>
    .recompense-wrapper {
        background: #f4f6fb;
        min-height: 100vh;
        padding: 30px;
        font-family: 'Segoe UI', sans-serif;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    .page-header h1 {
        font-size: 26px;
        font-weight: 700;
        color: #2d3748;
        margin: 0;
    }

    .header-actions { display: flex; gap: 10px; }

    .btn-primary-custom {
        padding: 10px 20px;
        background: #6f42c1;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        font-weight: 600;
    }

    .btn-primary-custom:hover { background: #5a32a3; }

    .btn-stats {
        padding: 10px 20px;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
    }

    .btn-stats:hover { opacity: 0.9; color: white; }

    .alert-custom { padding: 12px 16px; border-radius: 10px; margin-bottom: 15px; font-size: 14px; }
    .alert-success { background: #d1e7dd; color: #0f5132; }
    .alert-danger  { background: #f8d7da; color: #842029; }

    .card-white {
        background: white;
        border-radius: 16px;
        padding: 20px 25px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }

    .card-white .card-title {
        font-size: 15px;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 15px;
    }

    .filtre-grid {
        display: grid;
        grid-template-columns: 1fr 1fr auto;
        gap: 15px;
        align-items: end;
    }

    .form-label-custom {
        font-size: 13px;
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 6px;
        display: block;
    }

    .form-control-custom, .form-select-custom {
        width: 100%;
        padding: 9px 12px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 14px;
        color: #2d3748;
        outline: none;
        transition: border 0.2s;
    }

    .form-control-custom:focus, .form-select-custom:focus { border-color: #6f42c1; }

    .btn-search {
        padding: 9px 18px;
        background: #6f42c1;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        font-weight: 600;
        margin-right: 8px;
    }

    .btn-reset {
        padding: 9px 14px;
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        text-decoration: none;
    }

    .table-wrapper {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        overflow: hidden;
        margin-bottom: 20px;
    }

    table { width: 100%; border-collapse: collapse; }

    thead tr {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    thead th {
        padding: 14px 16px;
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    tbody tr {
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.15s;
    }

    tbody tr:hover { background: #f8f6ff; }
    tbody tr:last-child { border-bottom: none; }
    tbody td { padding: 13px 16px; font-size: 14px; color: #4a5568; }

    .badge-type { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .badge-commission    { background: #d1e7dd; color: #0f5132; }
    .badge-bonus-mensuel { background: #cfe2ff; color: #084298; }
    .badge-prime-perf    { background: #fff3cd; color: #664d03; }
    .badge-default       { background: #e2e3e5; color: #41464b; }

    .valeur-cell { font-weight: 700; color: #198754; }

    .btn-edit {
        padding: 5px 10px;
        background: #fff3cd;
        color: #664d03;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        margin-right: 4px;
    }

    .btn-edit:hover { background: #ffc107; }

    .btn-delete {
        padding: 5px 10px;
        background: #f8d7da;
        color: #842029;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        margin-right: 4px;
    }

    .btn-delete:hover { background: #dc3545; color: white; }

    .btn-qr {
        padding: 5px 10px;
        background: #e8f4fd;
        color: #0d6efd;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        text-decoration: none;
        display: inline-block;
        margin-right: 4px;
    }

    .btn-qr:hover { background: #0d6efd; color: white; }

    .badge-auto {
        padding: 4px 10px;
        background: #e2e3e5;
        color: #41464b;
        border-radius: 6px;
        font-size: 11px;
    }

    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }

    .card-gradient {
        border-radius: 16px;
        padding: 25px;
        color: white;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        text-align: center;
    }

    .card-gradient .icon  { font-size: 36px; margin-bottom: 10px; opacity: 0.85; }
    .card-gradient .label { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; opacity: 0.9; }
    .card-gradient .value { font-size: 28px; font-weight: 700; }

    .g1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .g2 { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .g3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }

    .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal-overlay.active { display: flex; }

    .modal-box {
        background: white;
        border-radius: 16px;
        width: 580px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        animation: slideIn 0.2s ease;
    }

    @keyframes slideIn {
        from { transform: translateY(-20px); opacity: 0; }
        to   { transform: translateY(0);     opacity: 1; }
    }

    .modal-header {
        padding: 20px 25px;
        border-radius: 16px 16px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h5 { margin: 0; font-size: 17px; font-weight: 700; color: white; }
    .modal-header-create { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .modal-header-edit   { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .modal-header-delete { background: linear-gradient(135deg, #dc3545 0%, #a71d2a 100%); }

    .btn-close-modal {
        background: rgba(255,255,255,0.3);
        border: none;
        color: white;
        width: 30px; height: 30px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-body   { padding: 25px; }
    .modal-footer {
        padding: 15px 25px;
        border-top: 1px solid #f0f0f0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .form-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .form-group  { margin-bottom: 15px; }

    .alert-info-custom {
        background: #e8f4fd;
        color: #0c5460;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 13px;
        margin-bottom: 20px;
    }

    .btn-save {
        padding: 10px 20px;
        background: #6f42c1;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
    }

    .btn-save:hover { background: #5a32a3; }

    .btn-cancel {
        padding: 10px 20px;
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-danger-custom {
        padding: 10px 20px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
    }

    /* ===== STYLES BOUTON IA ===== */
    .btn-ai {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 6px;
        transition: opacity 0.2s;
    }

    .btn-ai:hover    { opacity: 0.88; }
    .btn-ai:disabled { opacity: 0.5; cursor: not-allowed; }

    .ai-status {
        font-size: 12px;
        margin-top: 6px;
        padding: 6px 10px;
        border-radius: 6px;
        display: none;
    }

    .ai-status.loading { display: block; background: #fff3cd; color: #856404; }
    .ai-status.success { display: block; background: #d1e7dd; color: #0f5132; }
    .ai-status.error   { display: block; background: #f8d7da; color: #842029; }

    @media (max-width: 768px) {
        .filtre-grid { grid-template-columns: 1fr; }
        .form-grid-2 { grid-template-columns: 1fr; }
        .grid-3      { grid-template-columns: 1fr; }
        .modal-box   { width: 95%; }
        .header-actions { flex-wrap: wrap; }
    }
</style>

<div class="recompense-wrapper">

    {# Header #}
    <div class="page-header">
        <h1>üèÜ Gestion des R√©compenses</h1>
        <div class="header-actions">
            <a href="{{ path('app_recompense_stats') }}" class="btn-stats">üìä Statistiques</a>
            <button class="btn-primary-custom" onclick="ouvrirModal('createModal')">
                + Cr√©er une r√©compense
            </button>
        </div>
    </div>

    {# Flash messages #}
    {% for message in app.flashes('success') %}
        <div class="alert-custom alert-success">‚úÖ {{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('error') %}
        <div class="alert-custom alert-danger">‚ùå {{ message }}</div>
    {% endfor %}

    {# Filtres #}
    <div class="card-white">
        <div class="card-title">üîç Recherche & Filtres</div>
        <form method="get">
            <div class="filtre-grid">
                <div>
                    <label class="form-label-custom">Type</label>
                    <select name="type" class="form-select-custom">
                        <option value="">Tous les types</option>
                        <option value="Commission"           {% if searchType == 'Commission' %}selected{% endif %}>Commission</option>
                        <option value="Bonus Mensuel"        {% if searchType == 'Bonus Mensuel' %}selected{% endif %}>Bonus Mensuel</option>
                        <option value="Prime de Performance" {% if searchType == 'Prime de Performance' %}selected{% endif %}>Prime de Performance</option>
                        <option value="Bonus"                {% if searchType == 'Bonus' %}selected{% endif %}>Bonus</option>
                        <option value="Prime"                {% if searchType == 'Prime' %}selected{% endif %}>Prime</option>
                    </select>
                </div>
                <div>
                    <label class="form-label-custom">Livreur</label>
                    <input type="text" name="livreur" class="form-control-custom"
                           placeholder="Nom du livreur..." value="{{ searchLivreur }}">
                </div>
                <div style="display:flex; gap:8px;">
                    <button type="submit" class="btn-search">üîç Rechercher</button>
                    <a href="{{ path('app_recompense_index') }}" class="btn-reset">‚Ü∫</a>
                </div>
            </div>
        </form>
    </div>

    {# Tableau #}
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Type</th>
                    <th>Livreur</th>
                    <th>Valeur</th>
                    <th>Description</th>
                    <th>Facture</th>
                    <th>Date</th>
                    <th style="text-align:center;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if recompenses is empty %}
                    <tr>
                        <td colspan="8" style="text-align:center; padding:40px; color:#6c757d;">
                            üèÜ Aucune r√©compense trouv√©e
                        </td>
                    </tr>
                {% else %}
                    {% for r in recompenses %}
                    <tr>
                        <td><strong>#{{ r.id }}</strong></td>
                        <td>
                            <span class="badge-type
                                {% if r.type == 'Commission' %}badge-commission
                                {% elseif r.type == 'Bonus Mensuel' %}badge-bonus-mensuel
                                {% elseif r.type == 'Prime de Performance' %}badge-prime-perf
                                {% else %}badge-default{% endif %}">
                                {{ r.type }}
                            </span>
                        </td>
                        <td>{{ r.livreur ? r.livreur.prenom ~ ' ' ~ r.livreur.nom : 'N/A' }}</td>
                        <td class="valeur-cell">{{ r.valeur|number_format(2) }} DT</td>
                        <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"
                            title="{{ r.description }}">
                            {{ r.description|slice(0, 40) }}{{ r.description|length > 40 ? '...' : '' }}
                        </td>
                        <td>{{ r.facture ? r.facture.numero : '-' }}</td>
                        <td>{{ r.dateObtention|date('d/m/Y') }}</td>
                        <td style="text-align:center; white-space:nowrap;">
                            <a href="{{ path('app_recompense_qrcode', {id: r.id}) }}"
                               target="_blank" class="btn-qr">üì± QR</a>
                            {% if r.type == 'Commission' or r.type == 'Bonus Mensuel' %}
                                <span class="badge-auto">üîí Auto</span>
                            {% else %}
                                <button class="btn-edit"
                                        onclick="openEditModal({{ r.id }}, '{{ r.type }}', {{ r.valeur }}, {{ r.livreur ? r.livreur.id : 'null' }}, {{ r.facture ? r.facture.id : 'null' }}, {{ r.seuil ?? 'null' }}, '{{ r.description|escape('js') }}')">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn-delete"
                                        onclick="confirmDelete({{ r.id }}, '{{ csrf_token('delete' ~ r.id) }}')">
                                    üóëÔ∏è
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>

    {# Stats r√©sum√© #}
    {% set total = 0 %}
    {% for r in recompenses %}{% set total = total + r.valeur %}{% endfor %}

    <div class="grid-3">
        <div class="card-gradient g1">
            <div class="icon">üèÜ</div>
            <div class="label">Total R√©compenses</div>
            <div class="value">{{ recompenses|length }}</div>
        </div>
        <div class="card-gradient g2">
            <div class="icon">üí∞</div>
            <div class="label">Valeur Totale</div>
            <div class="value">{{ total|number_format(2) }} DT</div>
        </div>
        <div class="card-gradient g3">
            <div class="icon">üìà</div>
            <div class="label">Moyenne</div>
            <div class="value">{{ recompenses|length > 0 ? (total / recompenses|length)|number_format(2) : 0 }} DT</div>
        </div>
    </div>

</div>

{# ===== MODAL CR√âATION ===== #}
<div class="modal-overlay" id="createModal">
    <div class="modal-box">
        <div class="modal-header modal-header-create">
            <h5>‚ûï Cr√©er une R√©compense</h5>
            <button class="btn-close-modal" onclick="fermerModal('createModal')">‚úï</button>
        </div>
        <form method="post" action="{{ path('app_recompense_new') }}">
            <div class="modal-body">
                <div class="alert-info-custom">
                    ‚ÑπÔ∏è Les <strong>Commissions</strong> et <strong>Bonus Mensuels</strong> sont g√©n√©r√©s automatiquement.
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label class="form-label-custom">Type <span style="color:red;">*</span></label>
                        <select name="type" id="create_type" class="form-select-custom" required>
                            <option value="">-- S√©lectionner --</option>
                            <option value="Prime de Performance">Prime de Performance</option>
                            <option value="Bonus">Bonus</option>
                            <option value="Prime">Prime</option>
                            <option value="Badge">Badge</option>
                            <option value="Cadeau">Cadeau</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label-custom">Valeur (DT) <span style="color:red;">*</span></label>
                        <input type="number" name="valeur" id="create_valeur" class="form-control-custom" step="0.01" required>
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label class="form-label-custom">Livreur <span style="color:red;">*</span></label>
                        <select name="livreur" id="create_livreur" class="form-select-custom" required>
                            <option value="">-- S√©lectionner --</option>
                            {% for livreur in livreurs %}
                                <option value="{{ livreur.id }}"
                                        data-prenom="{{ livreur.prenom }}"
                                        data-nom="{{ livreur.nom }}">
                                    {{ livreur.prenom }} {{ livreur.nom }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label-custom">Facture (optionnel)</label>
                        <select name="facture" class="form-select-custom">
                            <option value="">-- Aucune --</option>
                            {% for facture in factures %}
                                <option value="{{ facture.id }}">{{ facture.numero }} - {{ facture.montantTTC }} DT</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label-custom">Seuil (optionnel)</label>
                    <input type="number" name="seuil" class="form-control-custom" placeholder="Ex: Nombre de livraisons">
                </div>

                {# ===== DESCRIPTION + BOUTON IA ===== #}
                <div class="form-group">
                    <label class="form-label-custom">Description</label>
                    <textarea name="description" id="create_description" class="form-control-custom"
                              rows="3" style="resize:vertical;"
                              placeholder="√âcrivez une description ou g√©n√©rez-en une avec l'IA..."></textarea>
                    <button type="button" class="btn-ai" id="btn-ai-create" onclick="genererDescription('create')">
                        ü§ñ G√©n√©rer avec l'IA
                    </button>
                    <div class="ai-status" id="ai-status-create"></div>
                </div>
                {# ===== FIN ===== #}

            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="fermerModal('createModal')">Annuler</button>
                <button type="submit" class="btn-save">üíæ Cr√©er</button>
            </div>
        </form>
    </div>
</div>

{# ===== MODAL MODIFICATION ===== #}
<div class="modal-overlay" id="editModal">
    <div class="modal-box">
        <div class="modal-header modal-header-edit">
            <h5>‚úèÔ∏è Modifier la R√©compense</h5>
            <button class="btn-close-modal" onclick="fermerModal('editModal')">‚úï</button>
        </div>
        <form method="post" id="editForm">
            <div class="modal-body">
                <div class="alert-info-custom">
                    ‚ÑπÔ∏è Les <strong>Commissions</strong> et <strong>Bonus Mensuels</strong> sont g√©n√©r√©s automatiquement.
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label class="form-label-custom">Type <span style="color:red;">*</span></label>
                        <select name="type" id="edit_type" class="form-select-custom" required>
                            <option value="">-- S√©lectionner --</option>
                            <option value="Prime de Performance">Prime de Performance</option>
                            <option value="Bonus">Bonus</option>
                            <option value="Prime">Prime</option>
                            <option value="Badge">Badge</option>
                            <option value="Cadeau">Cadeau</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label-custom">Valeur (DT) <span style="color:red;">*</span></label>
                        <input type="number" name="valeur" id="edit_valeur" class="form-control-custom" step="0.01" required>
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label class="form-label-custom">Livreur <span style="color:red;">*</span></label>
                        <select name="livreur" id="edit_livreur" class="form-select-custom" required>
                            <option value="">-- S√©lectionner --</option>
                            {% for livreur in livreurs %}
                                <option value="{{ livreur.id }}"
                                        data-prenom="{{ livreur.prenom }}"
                                        data-nom="{{ livreur.nom }}">
                                    {{ livreur.prenom }} {{ livreur.nom }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label-custom">Facture (optionnel)</label>
                        <select name="facture" id="edit_facture" class="form-select-custom">
                            <option value="">-- Aucune --</option>
                            {% for facture in factures %}
                                <option value="{{ facture.id }}">{{ facture.numero }} - {{ facture.montantTTC }} DT</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label-custom">Seuil (optionnel)</label>
                    <input type="number" name="seuil" id="edit_seuil" class="form-control-custom">
                </div>

                {# ===== DESCRIPTION + BOUTON IA (EDIT) ===== #}
                <div class="form-group">
                    <label class="form-label-custom">Description</label>
                    <textarea name="description" id="edit_description" class="form-control-custom"
                              rows="3" style="resize:vertical;"></textarea>
                    <button type="button" class="btn-ai" id="btn-ai-edit" onclick="genererDescription('edit')">
                        ü§ñ G√©n√©rer avec l'IA
                    </button>
                    <div class="ai-status" id="ai-status-edit"></div>
                </div>
                {# ===== FIN ===== #}

            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="fermerModal('editModal')">Annuler</button>
                <button type="submit" class="btn-save">üíæ Enregistrer</button>
            </div>
        </form>
    </div>
</div>

{# ===== MODAL SUPPRESSION ===== #}
<div class="modal-overlay" id="deleteModal">
    <div class="modal-box" style="width:420px;">
        <div class="modal-header modal-header-delete">
            <h5>üóëÔ∏è Confirmer la suppression</h5>
            <button class="btn-close-modal" onclick="fermerModal('deleteModal')">‚úï</button>
        </div>
        <div class="modal-body" style="text-align:center; padding:30px;">
            <div style="font-size:50px; margin-bottom:15px;">‚ö†Ô∏è</div>
            <p style="font-size:16px; color:#2d3748; font-weight:600;">√ätes-vous s√ªr ?</p>
            <p style="color:#6c757d; font-size:14px;">Cette action est irr√©versible.</p>
        </div>
        <div class="modal-footer" style="justify-content:center;">
            <button class="btn-cancel" onclick="fermerModal('deleteModal')">Annuler</button>
            <form method="post" id="deleteForm" style="display:inline;">
                <input type="hidden" name="_token" id="delete_token">
                <button type="submit" class="btn-danger-custom">üóëÔ∏è Supprimer</button>
            </form>
        </div>
    </div>
</div>

<script>
// ===== MODALES =====
function ouvrirModal(id) {
    document.getElementById(id).classList.add('active');
}

function fermerModal(id) {
    document.getElementById(id).classList.remove('active');
}

document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', function(e) {
        if (e.target === this) fermerModal(this.id);
    });
});

function openEditModal(id, type, valeur, livreurId, factureId, seuil, description) {
    document.getElementById('editForm').action        = '/recompense/' + id + '/edit';
    document.getElementById('edit_type').value        = type;
    document.getElementById('edit_valeur').value      = valeur;
    document.getElementById('edit_livreur').value     = livreurId;
    document.getElementById('edit_facture').value     = factureId || '';
    document.getElementById('edit_seuil').value       = seuil || '';
    document.getElementById('edit_description').value = description;

    const status = document.getElementById('ai-status-edit');
    status.className  = 'ai-status';
    status.textContent = '';

    ouvrirModal('editModal');
}

function confirmDelete(id, token) {
    document.getElementById('deleteForm').action  = '/recompense/' + id + '/delete';
    document.getElementById('delete_token').value = token;
    ouvrirModal('deleteModal');
}

// ===== HUGGING FACE IA =====











async function genererDescription(mode) {
    const type           = document.getElementById(mode + '_type').value;
    const valeur         = document.getElementById(mode + '_valeur').value;
    const livreurSelect  = document.getElementById(mode + '_livreur');
    const selectedOption = livreurSelect.options[livreurSelect.selectedIndex];
    const btn            = document.getElementById('btn-ai-' + mode);
    const status         = document.getElementById('ai-status-' + mode);
    const textarea       = document.getElementById(mode + '_description');

    if (!type || !valeur || !livreurSelect.value) {
        status.className   = 'ai-status error';
        status.textContent = '‚ö†Ô∏è Veuillez remplir le Type, la Valeur et le Livreur.';
        return;
    }

    const prenom = selectedOption.getAttribute('data-prenom') || '';
    const nom    = selectedOption.getAttribute('data-nom') || '';

    btn.disabled       = true;
    btn.textContent    = '‚è≥ G√©n√©ration en cours...';
    status.className   = 'ai-status loading';
    status.textContent = 'ü§ñ L\'IA g√©n√®re une description, veuillez patienter...';

    try {
        const response = await fetch('{{ path("app_recompense_generate_description") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `type=${encodeURIComponent(type)}&valeur=${encodeURIComponent(valeur)}&prenom=${encodeURIComponent(prenom)}&nom=${encodeURIComponent(nom)}`
        });

        const data = await response.json();

        if (data.success) {
            textarea.value    = data.description;
            status.className  = 'ai-status success';
            status.textContent = '‚úÖ Description g√©n√©r√©e ! Vous pouvez la modifier.';
        } else {
            throw new Error(data.error || 'Erreur inconnue');
        }

    } catch (error) {
        status.className   = 'ai-status error';
        status.textContent = '‚ùå Erreur : ' + error.message;
    } finally {
        btn.disabled    = false;
        btn.textContent = 'ü§ñ G√©n√©rer avec l\'IA';
    }
}


</script>

{% endblock %}
