{% extends 'admin/base.html.twig' %}

{% block title %}Modifier Facture {{ facture.numero }}{% endblock %}

{% block body %}

<style>
    .edit-wrapper {
        background: #f4f6fb;
        min-height: 100vh;
        padding: 30px;
        font-family: 'Segoe UI', sans-serif;
    }
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }
    .page-header h1 { font-size: 26px; font-weight: 700; color: #2d3748; margin: 0; }
    .btn-retour {
        padding: 10px 20px;
        background: #6c757d;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-size: 14px;
    }
    .btn-retour:hover { background: #5a6268; color: white; }
    .alert-custom { padding: 12px 16px; border-radius: 10px; margin-bottom: 15px; font-size: 14px; }
    .alert-success { background: #d1e7dd; color: #0f5132; }
    .alert-danger  { background: #f8d7da; color: #842029; }
    .form-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        max-width: 700px;
        margin: 0 auto;
        overflow: hidden;
    }
    .form-card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px 25px;
        color: white;
    }
    .form-card-header h2 { margin: 0; font-size: 18px; font-weight: 700; }
    .form-card-header p  { margin: 5px 0 0; font-size: 13px; opacity: 0.85; }
    .form-card-body { padding: 30px; }
    .form-group { margin-bottom: 20px; }
    .form-label-custom {
        font-size: 13px;
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 6px;
        display: block;
    }
    .form-control-custom {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 14px;
        color: #2d3748;
        outline: none;
        transition: border 0.2s;
        box-sizing: border-box;
    }
    .form-control-custom:focus { border-color: #6f42c1; box-shadow: 0 0 0 3px rgba(111,66,193,0.1); }
    .form-control-custom.is-invalid { border-color: #dc3545; background: #fff5f5; }
    .form-control-readonly { background: #f8f9fa; color: #6c757d; cursor: not-allowed; }
    .invalid-feedback { color: #dc3545; font-size: 12px; margin-top: 5px; display: block; }
    .calcul-box {
        background: #f8f6ff;
        border: 1px solid #e0d6ff;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .calcul-box .titre { font-size: 14px; font-weight: 700; color: #6f42c1; margin-bottom: 15px; }
    .calcul-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        font-size: 14px;
        color: #4a5568;
        border-bottom: 1px solid #ede9ff;
    }
    .calcul-row:last-child {
        border-bottom: none;
        font-size: 16px;
        font-weight: 700;
        color: #198754;
        padding-top: 12px;
    }
    .calcul-row span:last-child { font-weight: 600; color: #2d3748; }
    .calcul-row:last-child span:last-child { color: #198754; }
    .form-actions { display: flex; justify-content: flex-end; gap: 10px; padding-top: 10px; }
    .btn-submit {
        padding: 11px 25px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
    }
    .btn-submit:hover { opacity: 0.9; }
    .btn-annuler {
        padding: 11px 20px;
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        text-decoration: none;
    }

    /* ‚îÄ‚îÄ Fraude IA styles ‚îÄ‚îÄ */
    .fraude-box {
        background: #fffbf0;
        border: 1px solid #fde68a;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .fraude-box .titre {
        font-size: 14px;
        font-weight: 700;
        color: #d97706;
        margin-bottom: 12px;
    }
    .btn-fraude {
        padding: 11px 22px;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
        width: 100%;
    }
    .btn-fraude:hover { opacity: 0.9; }
    .btn-fraude:disabled { opacity: 0.6; cursor: not-allowed; }

    #resultat-fraude { margin-top: 15px; display: none; }

    .fraude-result-card {
        border-radius: 10px;
        padding: 16px;
        font-size: 14px;
    }
    .fraude-result-card.authentique {
        background: #d1e7dd;
        border: 1px solid #a3cfbb;
        color: #0f5132;
    }
    .fraude-result-card.suspecte {
        background: #f8d7da;
        border: 1px solid #f1aeb5;
        color: #842029;
    }
    .fraude-result-card.erreur {
        background: #fff3cd;
        border: 1px solid #ffc107;
        color: #664d03;
    }
    .fraude-result-card h4 { margin: 0 0 10px; font-size: 16px; }
    .fraude-detail-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px solid rgba(0,0,0,0.08);
        font-size: 13px;
    }
    .fraude-detail-row:last-child { border-bottom: none; }
    .fraude-hash {
        font-size: 11px;
        color: #6c757d;
        word-break: break-all;
        margin-top: 10px;
        background: rgba(0,0,0,0.04);
        padding: 6px 10px;
        border-radius: 6px;
    }
</style>

<div class="edit-wrapper">

    <div class="page-header">
        <h1>‚úèÔ∏è Modifier la Facture</h1>
        <a href="{{ path('app_facture_index') }}" class="btn-retour">‚Üê Retour √† la liste</a>
    </div>

    {# Flash messages #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert-custom {{ label == 'error' ? 'alert-danger' : 'alert-success' }}">
                {{ label == 'error' ? '‚ùå' : '‚úÖ' }} {{ message }}
            </div>
        {% endfor %}
    {% endfor %}

    <div class="form-card">
        <div class="form-card-header">
            <h2>üìã Facture <strong>{{ facture.numero }}</strong></h2>
            <p>Modifiez les informations de la facture</p>
        </div>

        <div class="form-card-body">

            {# ‚îÄ‚îÄ üîè BLOC VERIFICATION FRAUDE IA ‚îÄ‚îÄ #}
            {% if facture.pdfUrl %}
            <div class="fraude-box">
                <div class="titre">üîè V√©rification Authenticit√© IA</div>
                <p style="font-size:13px; color:#6c757d; margin:0 0 12px;">
                    L'IA analyse le PDF de cette facture et d√©tecte toute tentative de falsification.
                </p>
                <button class="btn-fraude" id="btn-fraude" onclick="verifierFraude({{ facture.id }})">
                    üîç V√©rifier l'authenticit√© de cette facture
                </button>

                <div id="resultat-fraude"></div>
            </div>
            {% else %}
            <div class="fraude-box" style="opacity:0.6;">
                <div class="titre">üîè V√©rification Authenticit√© IA</div>
                <p style="font-size:13px; color:#6c757d; margin:0;">
                    ‚ö†Ô∏è Aucun PDF g√©n√©r√© pour cette facture. G√©n√©rez d'abord le PDF pour activer la v√©rification.
                </p>
            </div>
            {% endif %}

            <form action="{{ path('app_facture_edit', {'id': facture.id}) }}"
                  method="post" novalidate>

                <input type="hidden" name="_token"
                       value="{{ csrf_token('edit' ~ facture.id) }}">

                {# Num√©ro #}
                <div class="form-group">
                    <label class="form-label-custom">
                        Num√©ro de facture <span style="color:red">*</span>
                    </label>
                    <input type="text"
                           name="numero"
                           value="{{ facture.numero }}"
                           class="form-control-custom {{ errors.numero is defined ? 'is-invalid' : '' }}">
                    {% if errors.numero is defined %}
                        <span class="invalid-feedback">‚ùå {{ errors.numero }}</span>
                    {% endif %}
                </div>

                {# Date d'√©mission #}
                <div class="form-group">
                    <label class="form-label-custom">
                        Date d'√©mission <span style="color:red">*</span>
                    </label>
                    <input type="datetime-local"
                           name="dateEmission"
                           value="{{ facture.dateEmission ? facture.dateEmission|date('Y-m-d\\TH:i') : '' }}"
                           class="form-control-custom {{ errors.dateEmission is defined ? 'is-invalid' : '' }}">
                    {% if errors.dateEmission is defined %}
                        <span class="invalid-feedback">‚ùå {{ errors.dateEmission }}</span>
                    {% endif %}
                </div>

                {# Montant HT #}
                <div class="form-group">
                    <label class="form-label-custom">
                        Montant HT (DT) <span style="color:red">*</span>
                    </label>
                    <input type="number"
                           name="montantHT"
                           id="montantHT"
                           step="0.01"
                           min="0"
                           value="{{ facture.montantHT }}"
                           class="form-control-custom {{ errors.montantHT is defined ? 'is-invalid' : '' }}">
                    {% if errors.montantHT is defined %}
                        <span class="invalid-feedback">‚ùå {{ errors.montantHT }}</span>
                    {% endif %}
                </div>

                {# R√©sum√© calcul readonly #}
                <div class="calcul-box">
                    <div class="titre">üìä Calcul automatique</div>
                    <div class="calcul-row">
                        <span>Montant HT</span>
                        <span id="display-ht">
                            {{ facture.montantHT|number_format(2, '.', '') }} DT
                        </span>
                    </div>
                    <div class="calcul-row">
                        <span>TVA (20%)</span>
                        <span id="display-tva">
                            {{ (facture.montantHT * 0.20)|number_format(2, '.', '') }} DT
                        </span>
                    </div>
                    <div class="calcul-row">
                        <span>üí∞ Montant TTC</span>
                        <span id="display-ttc">
                            {{ (facture.montantHT * 1.20)|number_format(2, '.', '') }} DT
                        </span>
                    </div>
                </div>

                <div class="form-actions">
                    <a href="{{ path('app_facture_index') }}" class="btn-annuler">Annuler</a>
                    <button type="submit" class="btn-submit">üíæ Enregistrer</button>
                </div>

            </form>
        </div>
    </div>

</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const htInput    = document.getElementById('montantHT');
    const displayHT  = document.getElementById('display-ht');
    const displayTVA = document.getElementById('display-tva');
    const displayTTC = document.getElementById('display-ttc');

    htInput.addEventListener('input', function () {
        const ht = parseFloat(this.value);
        if (!isNaN(ht) && ht > 0) {
            displayHT.textContent  = ht.toFixed(2)          + ' DT';
            displayTVA.textContent = (ht * 0.20).toFixed(2) + ' DT';
            displayTTC.textContent = (ht * 1.20).toFixed(2) + ' DT';
        } else {
            displayHT.textContent  = '‚Äî';
            displayTVA.textContent = '‚Äî';
            displayTTC.textContent = '‚Äî';
        }
    });
});

function verifierFraude(factureId) {
    const btn = document.getElementById('btn-fraude');
    const div = document.getElementById('resultat-fraude');

    btn.disabled   = true;
    btn.textContent = '‚è≥ Analyse IA en cours...';
    div.style.display = 'none';

    fetch('/facture/' + factureId + '/verifier-fraude', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        div.style.display = 'block';

        if (data.error) {
            div.innerHTML = `
                <div class="fraude-result-card erreur">
                    <h4>‚ö†Ô∏è Erreur</h4>
                    <p>${data.error}</p>
                </div>`;
        } else if (data.statut && data.statut.includes('AUTHENTIQUE')) {
            div.innerHTML = `
                <div class="fraude-result-card authentique">
                    <h4>${data.statut}</h4>
                    <div class="fraude-detail-row">
                        <span>Coh√©rence math√©matique</span>
                        <span>${data.details.coherence_mathematique ? '‚úÖ OK' : '‚ùå Incorrecte'}</span>
                    </div>
                    <div class="fraude-detail-row">
                        <span>TVA l√©gale</span>
                        <span>${data.details.tva_legale ? '‚úÖ OK' : '‚ùå Invalide'}</span>
                    </div>
                    <div class="fraude-detail-row">
                        <span>Score IA</span>
                        <span>${data.score_anomalie} / seuil ${data.seuil}</span>
                    </div>
                    <div class="fraude-hash">üîê Hash PDF : ${data.hash}</div>
                </div>`;
        } else {
            div.innerHTML = `
                <div class="fraude-result-card suspecte">
                    <h4>${data.statut}</h4>
                    <div class="fraude-detail-row">
                        <span>Coh√©rence math√©matique</span>
                        <span>${data.details.coherence_mathematique ? '‚úÖ OK' : '‚ùå Incorrecte'}</span>
                    </div>
                    <div class="fraude-detail-row">
                        <span>TVA l√©gale</span>
                        <span>${data.details.tva_legale ? '‚úÖ OK' : '‚ùå Invalide'}</span>
                    </div>
                    <div class="fraude-detail-row">
                        <span>Score IA</span>
                        <span>${data.score_anomalie} / seuil ${data.seuil}</span>
                    </div>
                    <div class="fraude-hash">üîê Hash PDF : ${data.hash}</div>
                </div>`;
        }

        btn.disabled    = false;
        btn.textContent = 'üîç V√©rifier l\'authenticit√© de cette facture';
    })
    .catch(err => {
        div.style.display = 'block';
        div.innerHTML = `
            <div class="fraude-result-card erreur">
                <h4>‚ö†Ô∏è Service IA indisponible</h4>
                <p>V√©rifiez que l'API Python tourne sur le port 8002.</p>
            </div>`;
        btn.disabled    = false;
        btn.textContent = 'üîç V√©rifier l\'authenticit√© de cette facture';
    });
}
</script>
{% endblock %}
