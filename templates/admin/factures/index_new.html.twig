{% extends 'admin/base.html.twig' %}

{% block title %}Liste des factures{% endblock %}

{% block body %}

<style>
    .facture-wrapper {
        background: #f4f6fb;
        min-height: 100vh;
        padding: 30px;
        font-family: 'Segoe UI', sans-serif;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    .page-header h1 {
        font-size: 26px;
        font-weight: 700;
        color: #2d3748;
        margin: 0;
    }

    .header-actions { display: flex; gap: 10px; }

    .btn-new {
        padding: 10px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
    }

    .btn-calendar {
        padding: 10px 20px;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
    }

    .btn-new:hover    { opacity: 0.9; color: white; }
    .btn-calendar:hover { opacity: 0.9; color: white; }

    /* Flash */
    .alert-custom { padding: 12px 16px; border-radius: 10px; margin-bottom: 15px; font-size: 14px; }
    .alert-success { background: #d1e7dd; color: #0f5132; }
    .alert-danger  { background: #f8d7da; color: #842029; }

    /* Filtres */
    .card-white {
        background: white;
        border-radius: 16px;
        padding: 20px 25px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }

    .card-white .card-title {
        font-size: 15px;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 15px;
    }

    .filtre-grid {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .form-label-custom {
        font-size: 13px;
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 6px;
        display: block;
    }

    .form-select-custom, .form-input-custom {
        padding: 9px 12px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 14px;
        color: #2d3748;
        outline: none;
        transition: border 0.2s;
        background: white;
    }

    .form-select-custom:focus, .form-input-custom:focus {
        border-color: #6f42c1;
    }

    /* Tableau */
    .table-wrapper {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        overflow: hidden;
        margin-bottom: 20px;
    }

    .table-header-bar {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #f0f0f0;
    }

    .table-header-bar span {
        font-size: 15px;
        font-weight: 700;
        color: #2d3748;
    }

    .compteur {
        font-size: 13px;
        color: #6c757d;
        background: #f4f6fb;
        padding: 4px 12px;
        border-radius: 20px;
    }

    table { width: 100%; border-collapse: collapse; }

    thead tr {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    thead th {
        padding: 14px 16px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

    tbody tr {
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.15s;
    }

    tbody tr:hover { background: #f8f6ff; }
    tbody tr:last-child { border-bottom: none; }

    tbody td {
        padding: 13px 16px;
        font-size: 14px;
        color: #4a5568;
    }

    .statut-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .statut-emise   { background: #fff3cd; color: #664d03; }
    .statut-payee   { background: #d1e7dd; color: #0f5132; }
    .statut-annulee { background: #f8d7da; color: #842029; }

    .montant-cell { font-weight: 700; color: #2d3748; }
    .montant-ttc  { font-weight: 700; color: #198754; }

    .btn-voir {
    padding: 5px 10px;
    background: #fff3cd;
    color: #664d03;
    border: none;
    border-radius: 6px;
    text-decoration: none;
    font-size: 12px;
    font-weight: 600;
    margin-right: 4px;
}

    .btn-pdf {
        padding: 5px 10px;
        background: #f8d7da;
        color: #842029;
        border: none;
        border-radius: 6px;
        text-decoration: none;
        font-size: 12px;
        font-weight: 600;
        margin-right: 4px;
    }

    .btn-supprimer {
        padding: 5px 10px;
        background: #e2e3e5;
        color: #41464b;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-voir:hover { background: #ffc107; color: white; }
    .btn-pdf:hover      { background: #dc3545; color: white; }
    .btn-supprimer:hover { background: #6c757d; color: white; }

    .empty-state {
        text-align: center;
        padding: 50px;
        color: #6c757d;
    }

    .empty-state .icon { font-size: 48px; margin-bottom: 10px; }

    @media (max-width: 768px) {
        .filtre-grid { flex-direction: column; }
        .header-actions { flex-direction: column; }
    }
</style>

<div class="facture-wrapper">

    {# Header #}
    <div class="page-header">
        <h1>üßæ Liste des Factures</h1>
        <div class="header-actions">
            <a href="{{ path('app_facture_new') }}" class="btn-new">+ Nouvelle Facture</a>
            <a href="{{ path('app_facture_calendar') }}" class="btn-calendar">üìÖ Calendrier</a>
           
        </div>
    </div>

    {# Flash messages #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert-custom {{ label == 'error' ? 'alert-danger' : 'alert-success' }}">
                {{ label == 'error' ? '‚ùå' : '‚úÖ' }} {{ message }}
            </div>
        {% endfor %}
    {% endfor %}

    {# Filtres #}
    <div class="card-white">
        <div class="card-title">üîç Filtres</div>
        <div class="filtre-grid">
            <div>
                <label class="form-label-custom">Statut</label>
                <select id="filtreStatut" class="form-select-custom">
                    <option value="">Tous</option>
                    <option value="emise">üü° √âmise</option>
                    <option value="payee">üü¢ Pay√©e</option>
                    <option value="annulee">üî¥ Annul√©e</option>
                </select>
            </div>
            <div>
                <label class="form-label-custom">P√©riode</label>
                <select id="filtrePeriode" class="form-select-custom">
                    <option value="">Toutes</option>
                    <option value="mois_actuel">üìÖ Mois actuel</option>
                    <option value="mois_dernier">üìÖ Mois dernier</option>
                    <option value="date_specifique">üìÜ Choisir un mois</option>
                </select>
            </div>
            <div id="blocDateSpecifique" style="display:none;">
                <label class="form-label-custom">Mois / Ann√©e</label>
                <input type="date" id="dateSpecifique" class="form-input-custom">
            </div>
        </div>
    </div>

    {# Tableau #}
    <div class="table-wrapper">
        <div class="table-header-bar">
            <span>üìã Factures</span>
            <span class="compteur" id="compteurResultats"></span>
        </div>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>N¬∞ Facture</th>
                        <th>Date d'√©mission</th>
                        <th>ID Colis</th>
                        <th>Client</th>
                        <th>Livreur</th>
                        <th style="text-align:right;">Montant HT</th>
                        <th style="text-align:right;">TVA (20%)</th>
                        <th style="text-align:right;">Montant TTC</th>
                        <th style="text-align:center;">Statut</th>
                        <th style="text-align:center;">Actions</th>
                    </tr>
                </thead>
                <tbody id="corpsTableau">
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    const searchUrl = "{{ path('app_facture_search') }}";

    function chargerFactures() {
        const statut         = document.getElementById('filtreStatut').value;
        const periode        = document.getElementById('filtrePeriode').value;
        const dateSpecifique = document.getElementById('dateSpecifique').value;

        if (periode === 'date_specifique' && !dateSpecifique) {
            document.getElementById('corpsTableau').innerHTML = `
                <tr>
                    <td colspan="10" class="empty-state">
                        <div class="icon">üìÜ</div>
                        Veuillez s√©lectionner un mois.
                    </td>
                </tr>`;
            document.getElementById('compteurResultats').textContent = '';
            return;
        }

        const params = new URLSearchParams({ statut, periode, dateSpecifique });

        fetch(`${searchUrl}?${params.toString()}`)
            .then(response => response.text())
            .then(html => {
                document.getElementById('corpsTableau').innerHTML = html;
                const nbLignes = document.querySelectorAll('#corpsTableau tr').length;
                const estVide  = html.includes('Aucune facture');
                document.getElementById('compteurResultats').textContent =
                    estVide ? '' : `${nbLignes} facture(s) trouv√©e(s)`;
            })
            .catch(err => console.error('Erreur Ajax:', err));
    }

    document.getElementById('filtrePeriode').addEventListener('change', function () {
        const bloc = document.getElementById('blocDateSpecifique');
        bloc.style.display = this.value === 'date_specifique' ? 'block' : 'none';
        if (this.value !== 'date_specifique') document.getElementById('dateSpecifique').value = '';
        chargerFactures();
    });

    document.getElementById('filtreStatut').addEventListener('change', chargerFactures);
    document.getElementById('dateSpecifique').addEventListener('change', chargerFactures);

    chargerFactures();
</script>

{% endblock %}