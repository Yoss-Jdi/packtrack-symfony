{% extends 'admin/base.html.twig' %}
{% block title %}Pr√©vision CA ‚Äì PackTrack{% endblock %}

{% block body %}
<style>
    .prevision-wrapper {
        background: #f4f6fb;
        min-height: 100vh;
        padding: 30px;
        font-family: 'Segoe UI', sans-serif;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }
    .page-header h1 {
        font-size: 26px;
        font-weight: 700;
        color: #2d3748;
        margin: 0;
    }
    .header-actions { display: flex; gap: 10px; }

    /* ‚îÄ‚îÄ Badges ‚îÄ‚îÄ */
    .ia-badge {
        display: inline-block;
        padding: 6px 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 20px;
        margin-right: 10px;
    }
    .precision-badge {
        display: inline-block;
        padding: 6px 16px;
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 20px;
    }

    /* ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 25px;
    }
    .kpi-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        text-align: center;
        border-top: 4px solid transparent;
    }
    .kpi-card.violet { border-top-color: #667eea; }
    .kpi-card.vert   { border-top-color: #43e97b; }
    .kpi-card.rose   { border-top-color: #f093fb; }
    .kpi-card.orange { border-top-color: #fa709a; }
    .kpi-card .kpi-label {
        font-size: 12px;
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }
    .kpi-card .kpi-value {
        font-size: 22px;
        font-weight: 700;
        color: #2d3748;
    }
    .kpi-card .kpi-sub {
        font-size: 11px;
        color: #6c757d;
        margin-top: 4px;
    }

    /* ‚îÄ‚îÄ Cards pr√©dictions ‚îÄ‚îÄ */
    .cards-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 25px;
    }
    .card-prediction {
        background: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    .card-prediction::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 4px;
    }
    .card-prediction.hausse::before { background: linear-gradient(135deg, #43e97b, #38f9d7); }
    .card-prediction.baisse::before { background: linear-gradient(135deg, #f093fb, #f5576c); }

    .card-prediction .mois {
        font-size: 14px;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .card-prediction .montant {
        font-size: 32px;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 8px;
    }
    .card-prediction .tendance {
        font-size: 13px;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 20px;
        display: inline-block;
        margin-bottom: 8px;
    }
    .tendance-hausse { background: #d1e7dd; color: #0f5132; }
    .tendance-baisse { background: #f8d7da; color: #842029; }
    .base-sur {
        font-size: 11px;
        color: #6c757d;
        margin-top: 8px;
        background: #f8f9fa;
        padding: 5px 10px;
        border-radius: 8px;
    }

    /* ‚îÄ‚îÄ Graphique ‚îÄ‚îÄ */
    .chart-card {
        background: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        margin-bottom: 25px;
    }
    .chart-card h3 {
        font-size: 16px;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 20px;
    }

    /* ‚îÄ‚îÄ Tableau d√©taill√© ‚îÄ‚îÄ */
    .table-card {
        background: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        margin-bottom: 25px;
    }
    .table-card h3 {
        font-size: 16px;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 20px;
    }
    table { width: 100%; border-collapse: collapse; }
    thead tr {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    thead th {
        padding: 12px 16px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-align: left;
    }
    tbody tr { border-bottom: 1px solid #f0f0f0; transition: background 0.15s; }
    tbody tr:hover { background: #f8f6ff; }
    tbody td { padding: 12px 16px; font-size: 14px; color: #4a5568; }
    .type-reel { background: #e8f4fd; color: #0d6efd; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .type-prevu { background: #f3e8ff; color: #7c3aed; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }

    @media (max-width: 768px) {
        .kpi-grid   { grid-template-columns: repeat(2, 1fr); }
        .cards-grid { grid-template-columns: 1fr; }
    }
</style>

<div class="prevision-wrapper">

    {# ‚îÄ‚îÄ Header ‚îÄ‚îÄ #}
    <div class="page-header">
        <h1>üìà Pr√©vision du Chiffre d'Affaires</h1>
        <div class="header-actions">
            <a href="{{ path('app_facture_entrainer_ia') }}"
               style="padding:10px 20px; background:linear-gradient(135deg,#43e97b,#38f9d7);
                      color:white; text-decoration:none; border-radius:8px;
                      font-size:14px; font-weight:600;">
                üîÑ Re-entra√Æner avec mes donn√©es
            </a>
            <a href="{{ path('app_facture_index') }}"
               style="padding:10px 20px; background:#e2e3e5; color:#41464b;
                      text-decoration:none; border-radius:8px;
                      font-size:14px; font-weight:600;">
                ‚Üê Retour
            </a>
        </div>
    </div>

    {# Flash messages #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div style="padding:12px 16px; border-radius:10px; margin-bottom:15px;
                        background:{{ label == 'error' ? '#f8d7da' : '#d1e7dd' }};
                        color:{{ label == 'error' ? '#842029' : '#0f5132' }};">
                {{ label == 'error' ? '‚ùå' : '‚úÖ' }} {{ message }}
            </div>
        {% endfor %}
    {% endfor %}

    {# ‚îÄ‚îÄ Badges ‚îÄ‚îÄ #}
    <div>
        <span class="ia-badge">ü§ñ Mod√®le : R√©gression Lin√©aire (scikit-learn)</span>
        <span class="precision-badge">üéØ Algorithme : Historique Glissant (3 mois)</span>
    </div>

    {# ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ #}
    {% set totalReel = 0 %}
    {% set nbMoisReel = 0 %}
    {% set totalPrevu = 0 %}
    {% for h in historiqueCA %}
        {% if h.reel and h.ca > 0 %}
            {% set totalReel = totalReel + h.ca %}
            {% set nbMoisReel = nbMoisReel + 1 %}
        {% endif %}
        {% if not h.reel %}
            {% set totalPrevu = totalPrevu + h.ca %}
        {% endif %}
    {% endfor %}
    {% set moyenneReel = nbMoisReel > 0 ? totalReel / nbMoisReel : 0 %}

    <div class="kpi-grid">
        <div class="kpi-card violet">
            <div class="kpi-label">CA Total R√©el</div>
            <div class="kpi-value">{{ totalReel|number_format(2, '.', ' ') }} DT</div>
            <div class="kpi-sub">{{ nbMoisReel }} mois analys√©s</div>
        </div>
        <div class="kpi-card vert">
            <div class="kpi-label">CA Moyen / Mois</div>
            <div class="kpi-value">{{ moyenneReel|number_format(2, '.', ' ') }} DT</div>
            <div class="kpi-sub">Historique r√©el</div>
        </div>
        <div class="kpi-card rose">
            <div class="kpi-label">CA Pr√©vu (3 mois)</div>
            <div class="kpi-value">{{ totalPrevu|number_format(2, '.', ' ') }} DT</div>
            <div class="kpi-sub">Pr√©vision IA</div>
        </div>
        <div class="kpi-card orange">
            <div class="kpi-label">Tendance G√©n√©rale</div>
            <div class="kpi-value">
                {% if predictions|length > 0 and predictions[0].tendance == 'hausse' %}
                    üìà Hausse
                {% else %}
                    üìâ Baisse
                {% endif %}
            </div>
            <div class="kpi-sub">Prochain mois</div>
        </div>
    </div>

    {# ‚îÄ‚îÄ Cards pr√©dictions ‚îÄ‚îÄ #}
    <div class="cards-grid">
        {% for pred in predictions %}
        <div class="card-prediction {{ pred.tendance }}">
            <div class="mois">{{ pred.mois }}</div>
            <div class="montant">{{ pred.ca_prevu|number_format(2, '.', ' ') }} DT</div>
            <span class="tendance tendance-{{ pred.tendance }}">
                {{ pred.tendance == 'hausse' ? 'üìà Hausse' : 'üìâ Baisse' }}
            </span>
            <div class="base-sur">{{ pred.base_sur }}</div>
        </div>
        {% endfor %}
    </div>

    {# ‚îÄ‚îÄ Graphique ‚îÄ‚îÄ #}
    <div class="chart-card">
        <h3>üìä Historique r√©el + Pr√©visions IA</h3>
        <canvas id="chartCA" height="80"></canvas>
    </div>

    {# ‚îÄ‚îÄ Tableau d√©taill√© ‚îÄ‚îÄ #}
    <div class="table-card">
        <h3>üìã D√©tail par mois</h3>
        <table>
            <thead>
                <tr>
                    <th>Mois</th>
                    <th>Type</th>
                    <th style="text-align:right;">Montant (DT)</th>
                    <th style="text-align:center;">Tendance</th>
                </tr>
            </thead>
            <tbody>
                {% set prevCA = 0 %}
                {% for h in historiqueCA %}
                <tr>
                    <td><strong>{{ h.mois }}</strong></td>
                    <td>
                        {% if h.reel %}
                            <span class="type-reel">üìä R√©el</span>
                        {% else %}
                            <span class="type-prevu">ü§ñ Pr√©vu IA</span>
                        {% endif %}
                    </td>
                    <td style="text-align:right; font-weight:700;
                               color:{{ h.reel ? '#0d6efd' : '#7c3aed' }};">
                        {{ h.ca|number_format(2, '.', ' ') }} DT
                    </td>
                    <td style="text-align:center;">
                        {% if prevCA > 0 and h.ca > prevCA %}
                            <span style="color:#198754; font-weight:600;">üìà +{{ ((h.ca - prevCA) / prevCA * 100)|number_format(1) }}%</span>
                        {% elseif prevCA > 0 and h.ca < prevCA %}
                            <span style="color:#dc3545; font-weight:600;">üìâ -{{ ((prevCA - h.ca) / prevCA * 100)|number_format(1) }}%</span>
                        {% else %}
                            <span style="color:#6c757d;">‚Äî</span>
                        {% endif %}
                    </td>
                </tr>
                {% set prevCA = h.ca %}
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const historiqueCA = {{ historiqueCA|json_encode|raw }};

    const labels = historiqueCA.map(h => h.mois);
    const caReel = historiqueCA.map(h => h.reel ? h.ca : null);
    const caPrev = historiqueCA.map(h => !h.reel ? h.ca : null);

    new Chart(document.getElementById('chartCA'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'CA R√©el (DT)',
                    data: caReel,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102,126,234,0.1)',
                    borderWidth: 3,
                    pointRadius: 6,
                    pointBackgroundColor: '#667eea',
                    tension: 0.4,
                    spanGaps: false,
                    fill: true,
                },
                {
                    label: 'CA Pr√©vu par IA (DT)',
                    data: caPrev,
                    borderColor: '#f093fb',
                    backgroundColor: 'rgba(240,147,251,0.1)',
                    borderWidth: 3,
                    borderDash: [6, 3],
                    pointRadius: 6,
                    pointBackgroundColor: '#f093fb',
                    tension: 0.4,
                    spanGaps: false,
                    fill: true,
                }
            ]
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: ctx => ctx.parsed.y !== null
                            ? `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)} DT`
                            : null
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    ticks: { callback: val => val + ' DT' }
                },
                x: {
                    grid: { color: 'rgba(0,0,0,0.05)' }
                }
            }
        }
    });
</script>
{% endblock %}